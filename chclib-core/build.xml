<?xml version="1.0" encoding="UTF-8"?>

<project name="CHCLib" default="compile" basedir=".">

  <property environment="env"/>

<!-- ===================== Property Definitions ======================== -->

  <tstamp><format property="build.date" pattern="yyyy-MM-dd"/></tstamp>

  <property file="build.properties"/>
  <property file="${user.home}/build.properties"/>

  <property name="src.home"                     value="."/>
  <property name="java.src.home"                value="src/main/java"/>
  <property name="java.resources.home"          value="src/main/resources"/>
  <property name="java.deprecated.src.home"     value="src/deprecated/java"/>
  <property name="java.samples.src.home"        value="src/samples/java"/>
  <property name="java.samples.resources.home"  value="src/samples/java"/>
  <property name="java.test.src.home"           value="src/test/java"/>
  <property name="java.test.resources.home"     value="src/test/resources"/>

  <property name="build.number.file"        value="${java.resources.home}/build.number"/>

  <property file="${build.number.file}"/>

  <property name="app.name"     value="CHCLibCore"/>
  <property name="app.version"  value="${VERSION}.${REVISION}.${build.number}"/>
  <property name="build.home"   value=".ant/build"/>
  <property name="dist.home"    value=".ant/dist"/>
  <property name="reports.home" value=".ant/junit"/>

  <property name="jar.file"     value="${dist.home}/${app.name}.${app.version}.jar"/>
  <property name="docs.home"    value="${dist.home}-docs"/>

  <echo message="$VER: ${app.name} ${app.version} (${build.date})" />

  <dirname property="home.dir"   file="${src.home}/src"/>
  <dirname property="parent.dir" file="${src.home}"/>

  <!-- Configure the context path for this application -->
<!--  ==================== Compilation Control Options ================= -->

  <property name="compile.debug"       value="true"/>
  <property name="compile.deprecation" value="on"/>
  <property name="compile.optimize"    value="true"/>

<!-- ==================== Compilation Classpath ======================== -->

  <path id="compile.classpath">

    <!-- Ajout des jars du projet -->
    <fileset dir="${src.home}/../lib">
      <include name="*.jar"/>
    </fileset>

  </path>

<!-- ==================== All Target =================================== -->

  <target name="all" depends="clean,compile,dist,javadoc"
   description="Clean build and compile, then dist"/>

<!-- ==================== Clean Target ================================= -->

  <target name="clean"
   description="Delete old build and dist directories">
    <delete dir="${build.home}"/>
    <delete dir="${dist.home}"/>
    <delete dir="${docs.home}"/>
    <delete dir="${reports.home}"/>
  </target>

<!-- ==================== Compile Target =============================== -->

  <target name="compile" depends="prepare" description="Compile Java sources">

    <!-- Compile Java classes as necessary -->
    <mkdir  dir="${build.home}/classes"/>

    <javac destdir="${build.home}/classes"
            target="1.5"
            source="1.5"
             debug="${compile.debug}"
          optimize="${compile.optimize}"
       deprecation="${compile.deprecation}"
       includeantruntime="false"
       >
      <src path="${java.src.home}"/>
      <src path="${java.deprecated.src.home}"/>
      <src path="${java.samples.src.home}"/>
      <src path="${java.test.src.home}"/>
      <classpath refid="compile.classpath"/>
      <compilerarg value="-Xlint"/>
    </javac>

    <copy    todir="${build.home}/classes">
      <fileset dir="${java.src.home}"               excludes="**/*.java,**/*.java!,**/!*!"/>
      <fileset dir="${java.resources.home}"         excludes="**/*.java,**/*.java!,**/!*!"/>

      <fileset dir="${java.deprecated.src.home}"    excludes="**/*.java,**/*.java!,**/!*!"/>

      <fileset dir="${java.samples.src.home}"       excludes="**/*.java,**/*.java!,**/!*!"/>
      <fileset dir="${java.samples.resources.home}" excludes="**/*.java,**/*.java!,**/!*!"/>
    </copy>

  </target>

<!-- ==================== Dist Target ================================== -->
  <target name="dist" depends="compile"
   description="Create binary distribution">

    <buildnumber file="${build.number.file}"/>
    <mkdir dir="${dist.home}"/>

    <jar jarfile="${jar.file}"
         basedir="${build.home}/classes"
        >
      <manifest>
        <attribute name="X-Built-By"              value="${user.name}"/>
        <attribute name="X-Specification-Title"   value="${app.name}"/>
        <attribute name="X-Specification-Version" value="${app.version}"/>
      </manifest>
    </jar>

  </target>

<!-- ==================== Javadoc Target =============================== -->

  <target
    name="javadoc"
    depends="compile"
    description="Create Javadoc API documentation"
    >

    <property
        name="javadoc.j2se"
        value="http://download.oracle.com/javase/6/docs/api/"
        />
    <property name="api.docs.home" value="${docs.home}/api"/>

    <mkdir dir="${api.docs.home}"/>

    <javadoc sourcepath="${java.src.home}"
           packagenames="*"
                destdir="${api.docs.home}"
                 access="protected"
                    use="true"
                 Header="${app.name} ${app.version}"
                 Footer="${app.name} API"
             serialwarn="true"
                version="true"
                 author="true"
            failonerror="true"
               Doctitle="${app.name} API ${app.version} (Doctitle)"
            Windowtitle="${app.name} API ${app.version}"
         stylesheetfile="${src.home}/../metadata/stylesheet.css"
         >
      <classpath refid="compile.classpath"/>
      <excludepackage name="*.undocumented"/>
      <excludepackage name="*.testcase"/><!-- bug? -->
      <excludepackage name="alpha.*"/>
      <excludepackage name="deprecated.*"/>
      <excludepackage name="*.alpha"/>
      <excludepackage name="cx.ath.choisnet.bytesaccess.testcase"/>
      <excludepackage name="cx.ath.choisnet.io.testcase"/>
      <excludepackage name="cx.ath.choisnet.lang.testcase"/>
      <excludepackage name="cx.ath.choisnet.sql.testcase"/>
      <excludepackage name="cx.ath.choisnet.swing.introspection.testcase"/>
      <excludepackage name="cx.ath.choisnet.testcase"/>
      <excludepackage name="cx.ath.choisnet.util.base64.testcase"/>
      <excludepackage name="cx.ath.choisnet.util.checksum.testcase"/>
      <excludepackage name="cx.ath.choisnet.util.duplicate.testcase"/>
      <excludepackage name="cx.ath.choisnet.util.iterator.iterable.testcase"/>
      <excludepackage name="cx.ath.choisnet.util.iterator.testcase"/>
      <excludepackage name="cx.ath.choisnet.util.testcase"/>
      <excludepackage name="cx.ath.choisnet.zip.testcase"/>

      <link href="${javadoc.j2se}" offline="true"
            packagelistLoc="${src.home}/../metadata/javase6/"
            />
      <link href="http://junit.sourceforge.net/junit3.8.1/javadoc/"
         offline="true"
            packagelistLoc="${src.home}/../metadata/junit3.8.1/"
            />
      <link href="http://logging.apache.org/log4j/1.2/apidocs/"
         offline="true"
            packagelistLoc="${src.home}/../metadata/log4j-1.2/"
            />
      <doctitle>${app.name}</doctitle>
    </javadoc>

    <copy    todir="${api.docs.home}/resources"
         overwrite="true"
       failonerror="true"
         >
      <fileset dir="${src.home}/../metadata/resources" excludes="!*!"/>
    </copy>

  </target>

<!-- ==================== Prepare Target =============================== -->

  <target name="prepare">
    <mkdir  dir="${build.home}"/>
  </target>

<!-- ==================== JUnit Target ================================= -->
  <target name="junit"
          depends="compile"
          description="Lauche JUnit"
          >
    <mkdir dir="${reports.home}/raw"/>

    <copy    todir="${build.home}/classes">
      <fileset dir="${java.test.src.home}"        excludes="**/*.java,**/*.java!,**/!*!"/>
      <fileset dir="${java.test.resources.home}"  excludes="**/*.java,**/*.java!,**/!*!"/>
    </copy>

    <junit printsummary="yes" haltonfailure="yes" showoutput="yes" >
      <classpath refid="compile.classpath"/>
      <classpath>
        <pathelement path="${build.home}/classes"/>
      </classpath>
      <batchtest fork="yes" todir="${reports.home}/raw/">
        <formatter type="xml"/>
        <fileset dir="${java.src.home}"><!-- Should be empty -->
          <include name="**/Test*.java"/>
          <include name="**/*Test.java"/>
        </fileset>
        <fileset dir="${java.test.src.home}">
          <include name="**/Test*.java"/>
          <include name="**/*Test.java"/>
        </fileset>
      </batchtest>
    </junit>
  </target>

<!-- ====================== Arch Target ================================ -->

  <target name="arch" depends="clean">

    <property     name="arch.name" value="${build.date}.${app.name}.V${app.version}.src.7z"/>
    <property     name="exe"       value="${parent.dir}\bin\7z.exe"/>

    <echo message="arch.name  = ${arch.name}" />
    <echo message="home.dir   = ${home.dir}" />
    <echo message="parent.dir = ${parent.dir}" />
    <echo message="exe        = ${exe}" />
    <echo message="os.name    = ${os.name}" />

    <exec dir=".." executable="cmd.exe" os="Windows 2000,Windows XP">
      <arg line="/c ${exe} a -t7z ${arch.name} -r ${home.dir}/*  -mx=8 -mmt=on"/>
    </exec>

  </target>

<!-- =================================================================== -->

</project>
